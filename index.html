<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Phiếu yêu cầu - Đăng nhập</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .input-group {
            position: relative;
        }

        .input-group input {
            padding-left: 3rem;
        }

        .input-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feature-card {
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="login-page">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
            <h2 class="text-2xl font-bold mb-2">Quản lý Phiếu yêu cầu</h2>
            <p class="text-white/80">Đang tải hệ thống...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-6xl">
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <!-- Left Side - Login Form -->
                <div class="glass-morphism rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full mb-4">
                            <i class="fas fa-clipboard-list text-white text-2xl"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Quản lý Phiếu yêu cầu</h1>
                        <p class="text-gray-600">Hệ thống quản lý phiếu yêu cầu dịch vụ chuyên nghiệp</p>
                    </div>

                    <!-- Login Form -->
                    <form id="loginForm" class="space-y-6">
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input 
                                type="email" 
                                id="email" 
                                placeholder="Email của bạn"
                                class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                required
                            >
                        </div>

                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input 
                                type="password" 
                                id="password" 
                                placeholder="Mật khẩu"
                                class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                required
                            >
                        </div>

                        <div class="flex items-center justify-between">
                            <label class="flex items-center">
                                <input type="checkbox" id="rememberMe" class="rounded text-indigo-600" checked disabled>
                                <span class="ml-2 text-sm text-gray-600">Ghi nhớ đăng nhập (mặc định)</span>
                            </label>
                            <a href="#" class="text-sm text-indigo-600 hover:text-indigo-800">Quên mật khẩu?</a>
                        </div>

                        <button 
                            type="submit" 
                            id="loginBtn"
                            class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center"
                        >
                            <span id="loginBtnText">Đăng nhập</span>
                            <div id="loginSpinner" class="loading-spinner ml-2 hidden"></div>
                        </button>

                        <div class="text-center">
                            <p class="text-gray-600">
                                Liên hệ admin để tạo tài khoản
                            </p>
                        </div>
                    </form>

                    <!-- Google Login Button -->
                    <div class="mt-6">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">Hoặc đăng nhập với</span>
                            </div>
                        </div>

                        <button 
                            id="googleLoginBtn"
                            class="w-full mt-4 bg-white border border-gray-300 rounded-lg py-3 px-4 flex items-center justify-center hover:bg-gray-50 transition"
                        >
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Đăng nhập với Google
                        </button>
                    </div>
                </div>

                <!-- Right Side - Features -->
                <div class="space-y-6 fade-in">
                    <div class="glass-morphism rounded-xl p-6 feature-card">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-shield-alt text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">Bảo mật & Phân quyền</h3>
                        </div>
                        <p class="text-gray-600">Hệ thống xác thực đa tầng và phân quyền chi tiết, bảo vệ dữ liệu của bạn tuyệt đối.</p>
                    </div>

                    <div class="glass-morphism rounded-xl p-6 feature-card">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-link text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">Quản lý Phiếu yêu cầu</h3>
                        </div>
                        <p class="text-gray-600">Tạo và quản lý các phiếu yêu cầu dịch vụ chuyên nghiệp, theo dõi tiến độ xử lý và thống kê chi tiết.</p>
                    </div>

                    <div class="glass-morphism rounded-xl p-6 feature-card">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-sync text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">Đồng bộ Real-time</h3>
                        </div>
                        <p class="text-gray-600">Dữ liệu được đồng bộ tức thì trên mọi thiết bị, truy cập mọi lúc mọi nơi.</p>
                    </div>

                    <div class="glass-morphism rounded-xl p-6 feature-card">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-download text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">Thống kê & Báo cáo</h3>
                            </div>
                            <p class="text-gray-600">Theo dõi thống kê chi tiết về các phiếu yêu cầu, hiệu suất xử lý và xuất báo cáo chuyên nghiệp.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="glass-morphism rounded-lg shadow-lg p-4 flex items-center space-x-3 min-w-[300px]">
            <div id="toastIcon"></div>
            <div>
                <p id="toastMessage" class="font-semibold"></p>
                <p id="toastDescription" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCB9uARJMMaY-N6ikCRvOscgMNOCE5R0n4",
            authDomain: "luubbkythuatnhap.firebaseapp.com",
            projectId: "luubbkythuatnhap",
            storageBucket: "luubbkythuatnhap.firebasestorage.app",
            messagingSenderId: "914373130415",
            appId: "1:914373130415:web:f2aad04a7138d43c6afc5a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;

        // Utility functions
        function showLoading(show = true) {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            if (show) {
                loadingScreen.classList.remove('hidden');
                mainContainer.classList.add('hidden');
            } else {
                loadingScreen.classList.add('hidden');
                mainContainer.classList.remove('hidden');
            }
        }

        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            const spinner = document.getElementById(buttonId.replace('Btn', 'Spinner'));
            const text = document.getElementById(buttonId.replace('Btn', 'Text'));
            
            if (loading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
                if (text) text.textContent = 'Đang xử lý...';
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
                if (text) text.textContent = buttonId.includes('login') ? 'Đăng nhập' : 'Đăng ký';
            }
        }

        function showToast(message, description = '', type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            const toastDescription = document.getElementById('toastDescription');

            // Set icon based on type
            const icons = {
                success: '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                error: '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>',
                warning: '<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>',
                info: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
            };

            toastIcon.innerHTML = icons[type] || icons.info;
            toastMessage.textContent = message;
            toastDescription.textContent = description;

            toast.classList.remove('hidden');
            toast.classList.add('fade-in');

            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        // Authentication functions
        async function signInWithEmail(email, password) {
            try {
                setButtonLoading('loginBtn', true);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Update last login
                await db.collection('users').doc(currentUser.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                });

                showToast('Đăng nhập thành công!', 'Chào mừng trở lại', 'success');
                
                // Redirect to main app
                setTimeout(() => {
                    window.location.href = 'app.html';
                }, 1500);

            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Đăng nhập thất bại';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Email không tồn tại trong hệ thống';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Mật khẩu không chính xác';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email không hợp lệ';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Tài khoản đã bị vô hiệu hóa';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Quá nhiều lần đăng nhập, vui lòng thử lại sau';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showToast(errorMessage, 'Vui lòng kiểm tra lại thông tin', 'error');
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }

        async function signInWithGoogle() {
            try {
                setButtonLoading('googleLoginBtn', true);
                
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                currentUser = userCredential.user;

                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    // Create new user document with complete data structure
                    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('users').doc(currentUser.uid).set({
                        uid: currentUser.uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL,
                        role: 'user',
                        permissions: ['view', 'create', 'edit'],
                        isActive: true,
                        isOnline: true,
                        emailVerified: currentUser.emailVerified,
                        provider: 'google',
                        createdAt: serverTimestamp,
                        updatedAt: serverTimestamp,
                        lastLoginAt: serverTimestamp,
                        lastLogin: serverTimestamp,
                        lastSeen: serverTimestamp,
                        settings: {
                            theme: 'light',
                            requestsPerPage: 20,
                            defaultView: 'table',
                            autoRefreshInterval: 300000
                        }
                    });
                } else {
                    // Update existing user
                    await db.collection('users').doc(currentUser.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        isOnline: true,
                        photoURL: currentUser.photoURL
                    });
                }

                showToast('Đăng nhập thành công!', 'Chào mừng ' + currentUser.displayName, 'success');
                
                setTimeout(() => {
                    window.location.href = 'app.html';
                }, 1500);

            } catch (error) {
                console.error('Google login error:', error);
                showToast('Đăng nhập Google thất bại', error.message, 'error');
            } finally {
                setButtonLoading('googleLoginBtn', false);
            }
        }


        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            
            // Reset form
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure UI doesn't hang on loading if auth state event is delayed (e.g., GitHub Pages)
            let authStateHandled = false;
            const authTimeout = setTimeout(() => {
                if (!authStateHandled) {
                    console.warn('Auth state timeout fallback - showing login UI');
                    showLoading(false);
                }
            }, 4000);

            // Check if user is already logged in
            try {
                auth.onAuthStateChanged(async (user) => {
                    authStateHandled = true;
                    clearTimeout(authTimeout);

                    if (user) {
                        currentUser = user;
                        
                        // Update online status
                        try {
                            await db.collection('users').doc(user.uid).update({
                                isOnline: true,
                                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (error) {
                            console.log('User document might not exist yet');
                        }
                        
                        // Redirect to app from login page or base path
                        const path = window.location.pathname || '';
                        if (path === '/' || path.endsWith('/index.html') || path.endsWith('/testnhapyeucau/') || path.endsWith('/testnhapyeucau')) {
                            window.location.href = 'app.html';
                        } else {
                            window.location.href = 'app.html';
                        }
                    } else {
                        showLoading(false);
                    }
                });
            } catch (err) {
                console.error('Failed to attach auth state listener:', err);
                showLoading(false);
            }

            // Login form submission
            const loginFormEl = document.getElementById('loginForm');
            loginFormEl?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const emailEl = document.getElementById('email');
                const passwordEl = document.getElementById('password');
                const email = emailEl ? emailEl.value.trim() : '';
                const password = passwordEl ? passwordEl.value : '';

                if (!email || !password) {
                    showToast('Vui lòng nhập đầy đủ thông tin', '', 'warning');
                    return;
                }

                try {
                    // Ensure persistence is set before attempting sign-in
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                } catch (perr) {
                    console.warn('Failed to set auth persistence:', perr);
                }

                signInWithEmail(email, password);
            });

            // Google login
            const googleLoginBtnEl = document.getElementById('googleLoginBtn');
            googleLoginBtnEl?.addEventListener('click', signInWithGoogle);


            // Enter key support
            const passwordEl = document.getElementById('password');
            passwordEl?.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    loginFormEl?.dispatchEvent(new Event('submit'));
                }
            });


        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (currentUser && !document.hidden) {
                // Update online status when page becomes visible
                db.collection('users').doc(currentUser.uid).update({
                    isOnline: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                // Update online status to offline
                db.collection('users').doc(currentUser.uid).update({
                    isOnline: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
    </script>
</body>
</html>